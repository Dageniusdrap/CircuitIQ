generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String           @id @default(cuid())
  name                   String?
  email                  String           @unique
  emailVerified          DateTime?
  image                  String?
  role                   UserRole         @default(TECHNICIAN)
  password               String?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  twoFactorEnabled       Boolean          @default(false)
  twoFactorSecret        String?
  plan                   SubscriptionPlan @default(FREE)
  stripeCurrentPeriodEnd DateTime?
  stripeCustomerId       String?          @unique
  stripePriceId          String?
  stripeSubscriptionId   String?          @unique
  twoFactorBackupCodes   String?
  accounts               Account[]
  analyses               Analysis[]
  diagrams               Diagram[]
  feedback               Feedback[]
  sessions               Session[]
  subscription           Subscription?
  usageRecords           UsageRecord[]
  usageSummaries         UsageSummary[]
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(FREE)
  status               SubscriptionStatus @default(INACTIVE)
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  stripeCustomerId     String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  diagramsUsed         Int                @default(0)
  analysesUsed         Int                @default(0)
  aiQueriesUsed        Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String   @unique
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model Diagram {
  id                    String           @id @default(cuid())
  title                 String
  description           String?
  vehicleType           VehicleType
  manufacturer          String
  model                 String
  year                  Int?
  system                String
  systemCode            String?
  fileUrl               String
  fileKey               String
  fileType              String
  fileSize              Int
  thumbnailUrl          String?
  status                ProcessingStatus @default(PENDING)
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  processingError       String?
  aiExtractedData       Json?
  confidence            Float?
  uploadedById          String
  viewCount             Int              @default(0)
  downloadCount         Int              @default(0)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  analysisImageKey      String?
  analysisImageUrl      String?
  analyses              Analysis[]
  components            Component[]
  uploadedBy            User             @relation(fields: [uploadedById], references: [id])

  @@index([vehicleType, manufacturer, model])
  @@index([system])
  @@index([uploadedById])
  @@index([status])
  @@index([createdAt])
}

model Component {
  id                   String                @id @default(cuid())
  diagramId            String
  name                 String
  partNumber           String?
  alternatePartNumbers String?
  type                 String
  manufacturer         String?
  location             String?
  locationCode         String?
  function             String
  specifications       Json?
  operatingParams      Json?
  xPosition            Float?
  yPosition            Float?
  boundingBox          Json?
  extractedByAI        Boolean               @default(false)
  verifiedByUser       Boolean               @default(false)
  confidence           Float?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  diagram              Diagram               @relation(fields: [diagramId], references: [id], onDelete: Cascade)
  connectionsFrom      ComponentConnection[] @relation("FromComponent")
  connectionsTo        ComponentConnection[] @relation("ToComponent")
  failureModes         FailureMode[]
  testProcedures       TestProcedure[]

  @@index([diagramId])
  @@index([type])
  @@index([partNumber])
}

model ComponentConnection {
  id                 String    @id @default(cuid())
  fromId             String
  toId               String
  wireColor          String?
  wireGauge          String?
  wireLength         Float?
  wireRoute          String?
  connectorType      String?
  connectorPart      String?
  pinNumber          String?
  pinFunction        String?
  signalType         String?
  voltage            String?
  current            String?
  expectedResistance Float?
  expectedVoltage    Float?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  fromComponent      Component @relation("FromComponent", fields: [fromId], references: [id], onDelete: Cascade)
  toComponent        Component @relation("ToComponent", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
}

model FailureMode {
  id                  String    @id @default(cuid())
  componentId         String
  mode                String
  symptoms            String
  visualIndicators    String?
  directImpacts       Json
  cascadingEffects    Json
  safetyImplications  String?
  bypassPossible      Boolean   @default(false)
  bypassProcedure     String?
  bypassLimitations   String?
  isolationPossible   Boolean   @default(false)
  isolationProcedure  String?
  isolationEffects    String?
  probability         Float?
  severity            String?
  priority            String?
  repairProcedure     String?
  estimatedRepairTime Int?
  requiredTools       Json?
  requiredParts       Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  component           Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@index([componentId])
  @@index([mode])
  @@index([severity])
}

model TestProcedure {
  id                String    @id @default(cuid())
  componentId       String
  name              String
  description       String
  steps             Json
  requiredTools     Json
  safetyPrecautions Json
  prerequisites     String?
  expectedValues    Json
  passCriteria      String
  failCriteria      String
  testType          String
  estimatedTime     Int
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  component         Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@index([componentId])
  @@index([testType])
}

model Analysis {
  id                String        @id @default(cuid())
  diagramId         String
  userId            String
  symptom           String
  additionalContext String?
  aiResponse        Json
  suggestedTests    Json
  probableCauses    Json
  affectedSystems   Json?
  completedAt       DateTime?
  successful        Boolean?
  resolution        String?
  rootCause         String?
  helpful           Boolean?
  accuracy          Int?
  feedback          String?
  chatHistory       Json
  processingTime    Int?
  tokensUsed        Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  diagram           Diagram       @relation(fields: [diagramId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id])
  measurements      Measurement[]

  @@index([diagramId])
  @@index([userId])
  @@index([createdAt])
  @@index([successful])
}

model SystemIntegration {
  id               String      @id @default(cuid())
  systemName       String
  systemCode       String?
  vehicleType      VehicleType
  connectedSystems Json
  powerSources     Json
  groundPoints     Json
  dataInterfaces   Json?
  dependencies     Json
  dependents       Json
  emergencyBypass  String?
  redundancyInfo   String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([systemName, vehicleType])
  @@index([vehicleType])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model ConfirmedFix {
  id             String   @id @default(cuid())
  symptom        String
  vehicleMake    String
  vehicleModel   String
  vehicleYear    Int?
  componentName  String
  fixDescription String
  steps          Json?
  timesSolved    Int      @default(1)
  votes          Int      @default(0)
  difficulty     String?
  averageCost    Float?
  averageTime    Int?
  verifiedBy     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([symptom])
  @@index([vehicleMake, vehicleModel])
}

model TSB {
  id           String   @id @default(cuid())
  number       String   @unique
  title        String
  description  String
  manufacturer String
  models       Json
  years        Json?
  issue        String
  resolution   String
  pdfUrl       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([manufacturer])
}

model Measurement {
  id          String    @id @default(cuid())
  analysisId  String?
  componentId String?
  timestamp   DateTime  @default(now())
  type        String
  value       Float
  unit        String
  location    String?
  isAbnormal  Boolean   @default(false)
  notes       String?
  analysis    Analysis? @relation(fields: [analysisId], references: [id])

  @@index([analysisId])
  @@index([componentId])
}

model PartSource {
  id          String   @id @default(cuid())
  partNumber  String
  vendor      String
  price       Float
  currency    String   @default("USD")
  inStock     Boolean  @default(true)
  leadTime    String?
  buyLink     String?
  lastChecked DateTime @default(now())

  @@index([partNumber])
  @@index([vendor])
}

model Feedback {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  description String
  page        String?
  rating      Int?
  status      String   @default("pending")
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model UsageRecord {
  id                 String      @id @default(cuid())
  userId             String
  action             UsageAction
  resourceId         String?
  metadata           Json?
  billingPeriodStart DateTime
  billingPeriodEnd   DateTime
  createdAt          DateTime    @default(now())
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([billingPeriodStart, billingPeriodEnd])
}

model UsageSummary {
  id             String   @id @default(cuid())
  userId         String
  month          Int
  year           Int
  diagramUploads Int      @default(0)
  aiAnalyses     Int      @default(0)
  procedureViews Int      @default(0)
  pdfExports     Int      @default(0)
  dxfExports     Int      @default(0)
  apiCalls       Int      @default(0)
  uploadLimit    Int?
  analysisLimit  Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([year, month])
}

model PlanLimits {
  id                     String           @id @default(cuid())
  plan                   SubscriptionPlan @unique
  diagramUploadsPerMonth Int?
  aiAnalysesPerMonth     Int?
  procedureViewsPerMonth Int?
  pdfExportsPerMonth     Int?
  dxfExportsPerMonth     Int?
  apiCallsPerMonth       Int?
  maxStorageGB           Int?
  maxFileSize            Int?
  teamCollaboration      Boolean          @default(false)
  apiAccess              Boolean          @default(false)
  prioritySupport        Boolean          @default(false)
  customAITraining       Boolean          @default(false)
  whiteLabeling          Boolean          @default(false)
  maxTeamMembers         Int?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
}

enum UserRole {
  ADMIN
  ENGINEER
  TECHNICIAN
  VIEWER
}

enum VehicleType {
  AIRCRAFT
  AUTOMOTIVE
  MARINE
  ELECTRIC_VEHICLE
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SubscriptionPlan {
  FREE
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INACTIVE
}

enum UsageAction {
  DIAGRAM_UPLOAD
  AI_ANALYSIS
  PROCEDURE_VIEW
  EXPORT_PDF
  EXPORT_DXF
  API_CALL
}
